import{__awaiter as t,__generator as e,__extends as i,__spreadArray as s,__read as r,__assign as n}from"tslib";import{UTS_REFERRER_QUERY as o}from"@liff/consts";import{logger as f}from"@liff/logger";import{removeCredential as u,qs as c}from"@liff/util";import{getDecodedIDToken as a,getContext as d,getConfig as l}from"@liff/store";import{LiffModule as p}from"@liff/use";import{getVersion as h}from"@liff/get-version";import{isLoggedIn as g}from"@liff/is-logged-in";import{getProfile as b}from"@liff/get-profile";function I(){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:if(!g())return[3,6];e.label=1;case 1:return e.trys.push([1,5,,6]),(t=a())&&t.sub?[2,t.sub]:[3,2];case 2:return[4,b()];case 3:if((i=e.sent())&&i.userId)return[2,i.userId];e.label=4;case 4:return[3,6];case 5:return e.sent(),f.debug("can't retrieve Mid/Uid because of something wrong"),[3,6];case 6:return[2]}}))}))}function m(){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,I()];case 1:return(t=e.sent())&&"u"===t.substring(0,1)?[2,t]:[2]}}))}))}var L=function(a){function p(){var t=a.apply(this,s([],r(arguments),!1))||this;return t.utsExtra={isLiffSuccessful:!1,isLoggedIn:!1,id:"",version:""},t.injected=!1,t}return i(p,a),Object.defineProperty(p,"CUSTOMPLACEID_INIT",{get:function(){return"liff.init"},enumerable:!1,configurable:!0}),Object.defineProperty(p,"CUSTOMTYPE",{get:function(){return"liffSdk"},enumerable:!1,configurable:!0}),Object.defineProperty(p,"LiffUtsLoginStatus",{get:function(){return{isLoggedIn:1,isLiffSuccessful:2}},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"name",{get:function(){return"analytics"},enumerable:!1,configurable:!0}),p.prototype.install=function(t){var e=t.liff,i=t.internalHooks;this.liffCore=e,i.init.beforeFinished(this.beforeInitFinished.bind(this)),i.init.beforeSuccess(this.beforeInitSuccess.bind(this)),i.init.error(this.initError.bind(this))},p.prototype.changeRatioToUTSFormat=function(t){if(t&&Number.isFinite(t))return Math.round(100*t)},p.prototype.setExtra=function(){var t,e=this.utsExtra,i=e.isLiffSuccessful,s=e.isLoggedIn,r=e.id,n=e.version,o=(s?p.LiffUtsLoginStatus.isLoggedIn:0)|(i?p.LiffUtsLoginStatus.isLiffSuccessful:0);null===(t=this.uts)||void 0===t||t.setExtra("liff",{id:r,loginStatus:o,version:n})},p.prototype.assignUtsExtra=function(t){Object.assign(this.utsExtra,t)},p.prototype.setVersion=function(t){this.assignUtsExtra({version:t}),f.debug("[LIFFUTS][SDK version] ".concat(t)),this.setExtra()},p.prototype.setLiffId=function(t){this.assignUtsExtra({id:t}),f.debug("[LIFFUTS][LIFFID] ".concat(t)),this.setExtra()},p.prototype.setIsLoggedIn=function(t){this.assignUtsExtra({isLoggedIn:t}),f.debug("[LIFFUTS][isLoggedIn] ".concat(t)),this.setExtra()},p.prototype.sendLiffInit=function(){var t;f.debug("[LIFFUTS][sendCustom] liff.init"),null===(t=this.uts)||void 0===t||t.sendCustom({type:p.CUSTOMTYPE,params:{placeId:p.CUSTOMPLACEID_INIT}})},p.prototype.setIsLiffSuccessful=function(t){this.assignUtsExtra({isLiffSuccessful:t}),f.debug("[LIFFUTS][isLiffInitSuccessful] ".concat(t)),this.setExtra()},p.prototype.prepareReferrer=function(t){var e={};Object.keys(t).forEach((function(i){if(o.includes(i)){var s=t[i];"string"==typeof s&&s&&(e[i.replace(/^liff\.ref\./,"")]=s)}})),Object.keys(e).length>0&&(this.referrer=e)},p.prototype.beforeInitFinished=function(){return t(this,void 0,void 0,(function(){var t,i,s,r,o,a,p,b,I,L,S,v;return e(this,(function(e){switch(e.label){case 0:if(t=c.parse(window.location.search),this.prepareReferrer(t),i=d(),!(s=null==i?void 0:i.utsTracking))return[2];if(r=l(),o=r.liffId,a=r.analytics,"auto"!==s.mode||!a)return[3,6];f.debug("[LIFFUTS] ".concat((new Date).toUTCString())),e.label=1;case 1:return e.trys.push([1,3,,4]),p=this,[4,new Promise((function(t,e){var i=window.uts,s=document.createElement("script");s.type="text/javascript",s.src="https://static.line-scdn.net/uts/edge/4.1.0/uts.js",s.onload=function(){var e=window.uts;t(e),window.uts=i},s.onerror=function(t){e(t)},document.getElementsByTagName("head")[0].appendChild(s)}))];case 2:return p.uts=e.sent(),[3,4];case 3:return b=e.sent(),f.debug("[LIFFUTS] cannot load UTS, reason: ".concat(b)),[2];case 4:return I=n(n({},a.context),{utsId:a.context.utsId,appName:a.context.appName,appEnv:a.context.appEnv||"release"}),L=n(n({endpoint:"https://uts-front.line-apps.com"},a.options),{sampleRate:this.changeRatioToUTSFormat(s.sendRatio),version:"current"}),this.uts.init(I,L),[4,m()];case 5:(S=e.sent())&&(f.debug("[LIFFUTS][mid] ".concat(S)),this.uts.setMid(S)),(null==i?void 0:i.tid)&&(f.debug("[LIFFUTS][tid] ".concat(i.tid)),this.uts.setTid(i.tid)),this.referrer&&(f.debug("liff.ref.referrer",this.referrer),this.uts.setSessionParams(this.referrer)),o&&this.setLiffId(o),this.setIsLoggedIn(g()),this.setVersion(h()),v=u(location.href),f.debug("[LIFFUTS][url] ".concat(v)),this.uts.setUrl(v),this.liffCore.analytics=this.uts,this.injected=!0,e.label=6;case 6:return[2]}}))}))},p.prototype.beforeInitSuccess=function(){return this.injected&&(this.setIsLiffSuccessful(!0),this.sendLiffInit()),Promise.resolve()},p.prototype.initError=function(){return this.injected&&(this.setIsLiffSuccessful(!1),this.sendLiffInit()),Promise.resolve()},p}(p),S=function(t){f.debug("[LIFFUTS][sendCustom] liff.shareTargetPicker"),t.sendCustom({type:"liffSdk",params:{placeId:"liff.shareTargetPicker"}})};export{L as AnalyticsModule,S as sendShareTargetPicker};
